# 単体テストの価値を高めるリファクタリング

## 7.1 リファクタリングが必要なコードの識別

プロダクションコードは
- コードの複雑さ、ドメインにおける重要性
- 協力者オブジェクトの数

の2つの視点で以下の4つに分類できる。

1. ドメインモデル/アルゴリズム
2. 過度に複雑なコード
3. 取るに足らないコード
4. コントローラー

単体テストを行う価値が最も高いプロダクションコードはドメインモデル/アルゴリズムであるので、  
過度に複雑なコードはドメインモデル/アルゴリズムとコントローラに分割する.  

## 7.2 単体テストに価値を持たせるためのリファクタリング
過度に複雑なコードは下記の手順でリファクタリングを行う.  
- アプリケーションサービスを導入し、ドメインモデルから協力者オブジェクトを除外する
- アプリケーションサービスから複雑な箇所をドメインクラスとして抽出する
- ドメインクラスは1つの責務を持つよう分割する



## 7.3 プロダクション・コードの種類に紐づく効果的な単体テストの作成
単体テストはプロダクションコードが複雑なほど、ドメインにおける重要性が高いほど、退行に対する保護を保証でき、  
協力者オブジェクトの数が減るほど、保守コストを下げられるため,  
最も費用対効果の高いプロダクションコードの種類は,  
ドメインの重要性が高く、協力者オブジェクトの数が少ないコードである


## 7.4 コントローラーにおける条件付きロジックの扱い
条件によって振る舞いが異なるロジックを扱う場合、  
コントローラーの簡潔さを犠牲にし  
「決定を下す過程をさらに細かく分割する」ことで対応する。  
コントローラーの複雑さを抑える方法として
- 確認後実行パターン
- ドメインモデルの状態を追跡するドメインイベントの導入

がある

## 7.5 結論
外部システムに対して発生させる副作用を下記の手段でドメインから取り除きテストを簡単にする

- 副作用を起こす処理をビジネスオペレーションの最後まで実行しない
- ドメインイベントをコレクションに追加し、メッセージバスへのメッセージ送信を抽象化する
- ドメインクラスの状態を変更し、データベースの状態変更を抽象化する