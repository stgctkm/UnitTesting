## Ⅰ. 単体テストとは
単体テストの目的はプロジェクトの成長を持続可能にすることであり、  
そのためには良質なテストケースが必要である。

良質な単体テストは  
読みやすさ、保守しやすさ、リファクタリングのしやすさを備えている。



### 1. なぜ、単体テストを行うのか
単体テストの目的はプロジェクトの成長を持続可能にすることである。  
優れたテストは
- 開発サイクルの中に組み込まれ
- 重要な部分のみがテスト対象であり
- 最小限の保守コストで最大限の価値を生み出す

目的達成には、
- テストケースの善し悪しの区別
- リファクタリング

が必要である。


### 2. 単体テストとは何か
単体テストとは
- 1単位の振る舞い（a unit of behavior）を検証し
- 実行時間の短い
- 他のテストケースから隔離された状態で実行される

テストである。

統合テストは単体テストの3条件を満たさないテストである。

### 3. 単体テストの構造的解析
単体テストでは準備、実行、確認の3つのフェーズで記述し、1単位の振る舞いを検証する。  
1単位の振る舞いを1APIで実行するよう設計し、実行フェーズは1行にする。  
テストケース間の結合度を弱めるよう準備フェーズを記述する。  
読みやすさのために、各フェーズの区切り、メソッド名に留意する。

## Ⅱ. 単体テストとその価値
リファクタリングへの耐性、迅速なフィードバック、保守のしやすさを備えた
出力値ベースの ドメインモデル、アルゴリズムの単体テストが最も価値が高い。

過度に複雑なコードはリファクタリングでドメインモデル/アルゴリズムとそれ以外に分割し、
ドメインモデル/アルゴリズムのテストの価値を高める。


### 4. 良い単体テストを構成する4本の柱
良い単体テストを構成する柱は次の4性質である
- 退行に対する保護
- リファクタリングへの耐性
- 迅速なフィードバック
- 保守のしやすさ

リファクタリングへの耐性は必須で、
全てを最大に備えることはできないので
単体テストでは迅速なフィードバックを
結合テストでは退行に対する保護を備える

### 5. モックの利用とテストの壊れやすさ
モックは出力（コマンド）の模倣に使用し、入力（クエリー）の模倣には（テストを壊れやすくするので）使用しない。  
副作用が外部から観察できるシステム間のコミュニケーションにはモックを使用できるが、  
システム内のコミュニケーションのテストにモックを使用するとテストを壊れやすくする

### 6. 単体テストの3つの手法
単体テストには
出力値ベーステスト(副作用のない関数のテストで、最も質が高い)、
状態ベーステスト(テスト対象と、協力者の状態を検証)、
コミュニケーションベーステスト(テスト対象と協力者のコミュニケーションを検証するテストでモックを使用するため、保守が困難)
の3種類がある。


### 7. 単体テストの価値を高めるリファクタリング
プロダクションコードは
協力者オブジェクトの数/コードの複雑さ、ドメインにおける重要性の観点から
- ドメインモデル、アルゴリズム
- 取るに足らないコード
- 過度に複雑なコード
- コントローラ
に分類される。 ドメインモデル、アルゴリズのテストが最も価値の高い


## Ⅲ. 統合テスト
統合テストでは外部システムとの統合、  
コントローラーに分類されるコードのテストを行う。
プロセス外依存に対してのみモックを使用する。
データベースを扱う場合は、テスト内でスキーマ、データを準備する.
E2Eテストではモックは使用せず、クライアントの観点でのテストを行う。


### 8. なぜ統合テストを行うのか
統合テストでは
- コントローラーに分類されるコードを検証する
- 退行に対する保護とリファクタリングへの耐性を備える
- 1件のハッピーパスおよび、単体テストで扱えなかった異常ケースを扱う
- 管理下にある依存に対しては実際の依存を使い、管理下にない依存に対してはモックを使用する


### 9. モックのベストプラクティス
モックは管理下にない依存のみに適用する。
単体テストでは管理下にない依存を扱わないので、
モックは統合テストに限定して使用する。
モックを使用する際は、モックの呼び出し回数を確認する.


### 10. データベースに対するテスト
データベースは管理下にある依存なので、統合テストでは実際の依存を使用する。
テストの準備で、スキーマ、参照データを用意する
テストケースの異なるフェーズでは同じトランザクションや単位作業を使いまわさない。
テスト完了後にはデータの後始末を行う。

## Ⅳ. 単体テストのアンチパターン
良い単体テストを構成する柱は次の4性質である
- 退行に対する保護
- リファクタリングへの耐性
- 迅速なフィードバック
- 保守のしやすさ
でアンチパターンを分析する


### 11. 単体テストのアンチパターン
単体テストでは
- プライベートなメソッドをテストしない
- プライベートな状態を公開しない
- テストコードにドメイン知識を漏洩しない
- 具象クラスにモックを使用しない
- 現在日時は明示的に依存として注入する


























